# ðŸ§  NPC Behavior Evolution System

## Core Philosophy

**NPCs evolve dynamically through ALL interactions, not just quests.**

Every action the player takes around an NPC - conversation topics, body language, gifts, timing of visits, who they bring, what they wear, how they treat others - shapes that NPC's personality and behavior toward them.

---

## What is Behavior Evolution?

**Behavior evolution** is the gradual transformation of an NPC's personality, dialogue style, emotional responses, and decision-making based on accumulated experiences with the player.

### It's NOT:
- âŒ Scripted romance progression tied to quest flags
- âŒ Binary "liked/disliked" status
- âŒ Pre-written dialogue trees that unlock at thresholds
- âŒ Linear character arcs

### It IS:
- âœ… Emergent personality shifts from organic interactions
- âœ… Multi-dimensional relationship evolution (trust, respect, attraction, fear, admiration)
- âœ… Context-aware responses generated by Claude based on memory
- âœ… Non-linear character development with branching possibilities

---

## Evolution Dimensions

NPCs don't just have a single "relationship score." They evolve across multiple axes:

### 1. **Trust** (-100 to +100)
How much the NPC believes the player is reliable and honest.

**Increases from:**
- Keeping promises
- Protecting their secrets
- Being consistent in behavior
- Following through on commitments
- Showing up when needed

**Decreases from:**
- Breaking promises
- Revealing their secrets to others
- Inconsistent behavior
- Abandoning them in danger
- Lying (if caught)

### 2. **Respect** (-100 to +100)
How much the NPC admires the player's capabilities and character.

**Increases from:**
- Demonstrating skill in combat/crafting/dialogue
- Standing up to bullies or authority
- Showing wisdom in difficult choices
- Treating others with dignity
- Achieving difficult goals

**Decreases from:**
- Cowardice in face of danger
- Bullying weaker NPCs
- Poor decision-making
- Disrespecting others
- Failing at basic tasks

### 3. **Affection** (-100 to +100)
How much the NPC likes the player personally (platonic or romantic).

**Increases from:**
- Thoughtful gifts aligned with their interests
- Remembering personal details
- Sharing vulnerable moments
- Making them laugh
- Spending quality time together
- Complimenting genuinely

**Decreases from:**
- Ignoring them for long periods
- Insulting them or their loved ones
- Dismissing their feelings
- Inappropriate advances (if not receptive)
- Being consistently rude

### 4. **Fear** (-100 to +100)
How much the NPC is intimidated by or afraid of the player.

**Increases from:**
- Displays of overwhelming power
- Threats (implicit or explicit)
- Violence near them (even to enemies)
- Unpredictable behavior
- Dark/illegal activities they witness

**Decreases from:**
- Gentle, predictable behavior
- Protecting them from threats
- Showing vulnerability
- Apologizing when wrong
- Respecting their boundaries

### 5. **Familiarity** (0 to +100)
How well the NPC knows the player (always increases, never decreases).

**Increases from:**
- Time spent together
- Conversations about personal topics
- Witnessing player's actions
- Shared experiences
- Learning player's preferences

---

## Dynamic Evolution Triggers

### ðŸ—£ï¸ **Conversation-Based Evolution**

#### Topic Selection
What the player chooses to discuss matters:

```gdscript
# Player asks about NPC's family
gregor.record_interaction("conversation", {
    "topic": "family",
    "depth": "personal",
    "npc_emotion": "touched",
    "importance": 7
})
# Effect: +5 Affection, +3 Familiarity, +2 Trust
```

#### Emotional Intelligence
How the player responds to NPC emotions:

```gdscript
# Gregor mentions he's worried about daughter
# Player responds: "Want to talk about it?"
gregor.record_interaction("emotional_support", {
    "npc_state": "worried",
    "player_response": "offered_listening",
    "importance": 8
})
# Effect: +10 Affection, +8 Trust, +5 Familiarity
```

vs.

```gdscript
# Player responds: "That's rough. Anyway, about those swords..."
gregor.record_interaction("emotional_dismissal", {
    "npc_state": "worried",
    "player_response": "changed_subject",
    "importance": 7
})
# Effect: -5 Affection, -3 Trust
```

#### Conversation Timing
When you show up matters:

```gdscript
# Visit Gregor late at night repeatedly
gregor.record_interaction("visit_timing", {
    "time": "late_night",
    "frequency": "repeated",
    "npc_reaction": "concerned",
    "importance": 6
})
# Effect: -2 Affection ("Why are they always here so late?")
# Or: +5 Affection ("They make time for me despite busy schedule")
# Context-dependent based on existing relationship!
```

---

### ðŸ‘€ **Observation-Based Evolution**

NPCs watch what you do, not just what you say:

#### Treatment of Others
```gdscript
# Player tips waitress generously (Gregor watching)
gregor.record_interaction("witnessed_kindness", {
    "target": "waitress",
    "action": "generous_tip",
    "importance": 6
})
# Effect: +7 Respect, +5 Affection

# Player insults beggar (Gregor watching)
gregor.record_interaction("witnessed_cruelty", {
    "target": "beggar",
    "action": "insult",
    "importance": 8
})
# Effect: -10 Respect, -8 Affection, +3 Fear
```

#### Combat Style
```gdscript
# Player defeats bandits without killing (Gregor nearby)
gregor.record_interaction("witnessed_combat", {
    "style": "non_lethal",
    "efficiency": "skilled",
    "importance": 9
})
# Effect: +12 Respect, +5 Trust, -5 Fear

# Player brutally executes defeated enemies
gregor.record_interaction("witnessed_brutality", {
    "style": "execution",
    "necessity": "unnecessary",
    "importance": 10
})
# Effect: +5 Respect, -10 Affection, +15 Fear
```

#### Consistency Check
```gdscript
# Player claims to value honesty, then lies to guard
gregor.record_interaction("value_contradiction", {
    "claimed_value": "honesty",
    "actual_behavior": "lied",
    "importance": 9
})
# Effect: -15 Trust, -5 Respect
```

---

### ðŸŽ **Gift & Favor Evolution**

#### Thoughtfulness Over Value
```gdscript
# Player gives expensive sword (generic)
gregor.record_interaction("gift_received", {
    "item": "expensive_sword",
    "thoughtfulness": "low",  # Gregor is blacksmith, makes swords
    "value": "high",
    "importance": 5
})
# Effect: +3 Affection (appreciates gesture, but not personal)

# Player gives rare book about daughter's favorite topic
gregor.record_interaction("gift_received", {
    "item": "rare_book_horses",
    "thoughtfulness": "high",  # Remembered Elena loves horses
    "value": "medium",
    "importance": 9
})
# Effect: +15 Affection, +8 Trust, +10 Familiarity
```

#### Favors Without Asking for Reward
```gdscript
# Player fixes fence, refuses payment
gregor.record_interaction("unrequested_help", {
    "action": "fixed_fence",
    "payment_offered": "refused",
    "importance": 8
})
# Effect: +10 Trust, +8 Affection, +5 Respect
```

---

### â° **Time & Presence Evolution**

#### Showing Up
```gdscript
# Visit Gregor regularly (every 2-3 in-game days)
gregor.record_interaction("visit_pattern", {
    "frequency": "regular",
    "duration": "meaningful",  # Not just buying items
    "importance": 6
})
# Effect: +5 Affection per visit, +3 Familiarity

# Disappear for 30 in-game days after promising to help
gregor.record_interaction("absence", {
    "duration": "30_days",
    "context": "after_promise",
    "importance": 9
})
# Effect: -15 Trust, -10 Affection, +5 Familiarity ("I learned they're unreliable")
```

#### Being There in Crisis
```gdscript
# Village attacked, player fights alongside Gregor
gregor.record_interaction("shared_danger", {
    "event": "village_attack",
    "player_behavior": "fought_together",
    "importance": 10
})
# Effect: +20 Trust, +15 Respect, +10 Affection, +15 Familiarity

# Village attacked, player hides
gregor.record_interaction("abandonment", {
    "event": "village_attack",
    "player_behavior": "hid",
    "importance": 10
})
# Effect: -25 Trust, -20 Respect, -15 Affection
```

---

### ðŸ’¬ **Meta-Communication Evolution**

#### Remembering Details
```gdscript
# Gregor mentioned daughter Elena 20 days ago
# Player asks: "How's Elena doing?"
gregor.record_interaction("remembered_detail", {
    "detail": "daughter_name",
    "time_since_mentioned": "20_days",
    "importance": 8
})
# Effect: +10 Affection, +8 Familiarity, +5 Trust
```

#### Body Language (Future Enhancement)
```gdscript
# Player maintains appropriate distance during serious conversation
gregor.record_interaction("body_language", {
    "context": "serious_talk",
    "distance": "respectful",
    "importance": 5
})
# Effect: +3 Respect, +2 Trust
```

---

## Optimal Evolution Paths

### ðŸŒŸ **The Trusted Ally**
**Goal:** High Trust + High Respect + Medium Affection

**Path:**
1. Complete favors without expecting payment
2. Keep every promise, even small ones
3. Demonstrate competence in challenges
4. Protect NPC and their interests consistently
5. Be honest, even when it's hard
6. Show up regularly and reliably

**Behaviors Claude Will Generate:**
- Confides important secrets
- Asks for help with dangerous tasks
- Introduces player to important contacts
- Defends player's reputation to others
- Offers insider information and opportunities

**Example Dialogue Evolution:**

**Week 1 (Stranger):**
*"What do you want?"*

**Week 4 (Proven Reliable):**
*"Ah, good to see you. I've got something you might be interested in."*

**Week 8 (Trusted Ally):**
*"Listen, I need your help with something serious. You're the only one I can trust with this."*

---

### ðŸ’• **The Romantic/Intimate Partner**
**Goal:** High Trust + High Affection + Medium Respect + Low Fear

**Philosophy:** Romance and intimacy exist on a spectrum. NPCs may be attracted to any player regardless of gender, sexuality, or identity. Each NPC has their own preferences, boundaries, and approach to intimacy - some seek romance, others casual encounters, some both or neither.

**Path:**
1. All of "Trusted Ally" path foundations
2. Give thoughtful gifts aligned with their interests
3. Remember and reference personal details
4. Spend time together without transactional purpose
5. Show genuine interest in their life/family/dreams
6. Flirt appropriately (respect boundaries, read signals)
7. Be vulnerable and share personal stories
8. Protect them and their loved ones
9. Build chemistry through banter and shared experiences
10. Respect their pace and preferences

**Behaviors Claude Will Generate:**
- Drops flirtatious hints (subtle â†’ overt as trust builds)
- Shows interest in player's personal life
- Creates opportunities to be alone together
- Shares vulnerabilities and desires
- Responds to player's flirtation positively
- Initiates or accepts intimate encounters
- May prefer casual intimacy, romance, or both (personality-dependent)

**Example Dialogue Evolution:**

**Week 1 (Stranger):**
*"Welcome to my shop."*

**Week 6 (Growing Attraction):**
*"You know, you have excellent taste. In swords... and other things."*

**Week 12 (Mutual Interest):**
*"I've been thinking about you. More than I probably should."*

**Week 16 (Romantic Interest):**
*"There's a festival tonight. Would you... want to go together? As more than friends?"*

**Week 16 (Casual/Intimate Alternative):**
*"You've been on my mind. Want to come back to my place? No strings, just... us."*

**Post-Intimacy (Relationship-Dependent):**
- Romantic NPCs: Deeper emotional connection, relationship commitment dialogue
- Casual NPCs: Friendly intimacy, no pressure for commitment
- Both valid paths with different narrative arcs

### ðŸŒˆ Intimacy & Romance Mechanics

#### Sexuality & Attraction
- **Player-Sexual by Default**: Most NPCs can be attracted to player regardless of gender/presentation
- **Defined Preferences**: Some NPCs have specific attraction patterns (personality trait)
- **Spectrum Representation**: NPCs may identify as monogamous, polyamorous, aromantic, asexual, demisexual, etc.
- **Respectful Rejection**: If player pursues incompatible NPC, Claude generates kind but firm boundary-setting

#### Intimacy Scenes (Baldur's Gate III Style)
When relationship thresholds are met and player initiates:

```gdscript
# Triggered by high Affection + Trust + mutual attraction
if relationship_affection > 60 and relationship_trust > 50:
    # NPC personality determines type of encounter available
    if personality.intimacy_preference == "romantic":
        # Romantic scene: emotional connection, tender dialogue, fade-to-black
        EventBus.emit_signal("trigger_intimacy_scene", {
            "npc_id": npc_id,
            "type": "romantic",
            "location": "private_setting"
        })
    elif personality.intimacy_preference == "casual":
        # Casual scene: physical attraction, playful dialogue, fade-to-black
        EventBus.emit_signal("trigger_intimacy_scene", {
            "npc_id": npc_id,
            "type": "casual",
            "location": "private_setting"
        })
    elif personality.intimacy_preference == "both":
        # Player choice: pursue romance or keep it casual
        show_dialogue_choice([
            "I care about you deeply. I want this to mean something.",
            "No need to complicate things. Let's just enjoy each other."
        ])
```

**Scene Elements:**
- Pre-intimacy dialogue (consent, desire, boundaries)
- Fade-to-black transition with suggestive narration
- Post-intimacy dialogue (varies by relationship type)
- Memory stored with high importance (9-10)
- Relationship impacts (Affection +10-20, Trust +5-15, Familiarity +15)

**Post-Intimacy Evolution:**
- **Romantic Path**: Relationship deepens, exclusive commitment options, jealousy if player pursues others
- **Casual Path**: Friendly intimacy, no exclusivity expected, can continue or evolve
- **Complications**: NPCs react authentically to player's choices (multiple partners, broken hearts, reputation)

#### Example NPC Intimacy Profiles

**Gregor (Demisexual, Romantic):**
- Requires deep emotional trust before physical attraction
- Prefers committed relationship
- Intimacy threshold: Affection > 70, Trust > 60, Familiarity > 50
- Post-intimacy: Wants exclusivity, will be hurt if player sleeps with others

**Lyra the Bard (Pansexual, Polyamorous, Casual):**
- Attracted to confident, charismatic people regardless of gender
- Comfortable with multiple partners
- Intimacy threshold: Affection > 50, Trust > 30 (lower barriers)
- Post-intimacy: Friendly, no possessiveness, encourages player to enjoy life

**Kael the Warrior (Aromantic, Asexual):**
- Deep platonic bonds only
- Not interested in romance or physical intimacy
- If player flirts: Gentle rejection, explains orientation
- Alternative deep bond: Battle-brothers/sisters, loyalty-based relationship

**Sera the Rogue (Bisexual, Demiromantic):**
- Attracted to multiple genders
- Casual at first, may develop romantic feelings over time
- Intimacy threshold (casual): Affection > 40, Trust > 25
- Intimacy threshold (romantic): Affection > 75, Trust > 70, Familiarity > 60
- Evolution: Casual hookups can transform into love if relationship deepens

---

### ðŸ˜¨ **The Intimidated Informant**
**Goal:** High Fear + Medium Respect + Low Trust + Low Affection

**Path:**
1. Display overwhelming combat prowess
2. Make subtle threats
3. Be unpredictable in behavior
4. Show mercy occasionally (but arbitrarily)
5. Reward cooperation, punish resistance
6. Demonstrate connections to dangerous people

**Behaviors Claude Will Generate:**
- Provides information quickly to avoid conflict
- Nervous, jumpy dialogue
- Tries to appease player
- Warns player about threats (self-preservation)
- Doesn't refuse requests (too afraid)
- Avoids eye contact, submissive body language

**Example Dialogue Evolution:**

**Week 1 (Neutral):**
*"Can I help you?"*

**Week 4 (Growing Fear):**
*"Oh! You. Yes, whatever you need. Right away."*

**Week 8 (Intimidated):**
*"Please, I told you everything I know. I haven't talked to anyone, I swear!"*

---

### ðŸ¤ **The Business Partner**
**Goal:** High Respect + Medium Trust + Low Affection + Low Fear

**Path:**
1. Consistently deliver results
2. Negotiate fairly but firmly
3. Share profitable opportunities
4. Keep business and personal separate
5. Demonstrate market knowledge
6. Be punctual and professional

**Behaviors Claude Will Generate:**
- Offers exclusive deals and partnerships
- Shares market intelligence
- Proposes joint ventures
- Respects player's time and expertise
- Maintains professional boundaries
- Refers lucrative contacts

**Example Dialogue Evolution:**

**Week 1 (Customer):**
*"Browse at your leisure."*

**Week 4 (Valuable Client):**
*"I saved the best stock for you. You've earned it."*

**Week 8 (Business Partner):**
*"I have a proposition. There's profit to be made if we work together."*

---

### ðŸŽ­ **The Reluctant Acquaintance**
**Goal:** Medium Respect + Low Trust + Low Affection + Medium Fear

**Path:**
1. Be inconsistent in keeping promises
2. Show competence but questionable morals
3. Help sometimes, ignore other times
4. Be polite but keep secrets
5. Display power but don't threaten directly

**Behaviors Claude Will Generate:**
- Polite but guarded responses
- Shares surface-level information only
- Declines personal requests
- Maintains emotional distance
- Professional but not friendly
- Watches player carefully

**Example Dialogue Evolution:**

**Week 1 (Stranger):**
*"Hello."*

**Week 4 (Uncertain):**
*"You're... certainly capable. I'll give you that."*

**Week 8 (Wary):**
*"I can help with that, but let's keep this strictly business."*

---

## Sub-Optimal Evolution Paths

### âš ï¸ **The Confused Relationship**
**Symptoms:** Contradictory stats (High Trust + High Fear, or High Affection + Low Respect)

**Causes:**
- Player is kind to NPC but cruel to others
- Promises kept but through violent means
- Gifts given but boundaries violated
- Helpful but unpredictable

**NPC Behaviors:**
- Conflicted, inconsistent responses
- Expresses confusion about player's intentions
- Hot-and-cold emotional reactions
- Difficulty committing to deeper relationship

**Claude Might Generate:**
*"I don't know what to make of you. You've been so good to me, but I've seen what you're capable of. It scares me."*

**Fix:**
- Be consistent in values and behavior
- Align actions with stated beliefs
- Don't mix intimidation with friendship

---

### ðŸ’” **The Failed Romance**
**Symptoms:** Relationship started romantic but crashed (High Affection â†’ Low Affection, High Trust â†’ Low Trust)

**Causes:**
- Pushed physical intimacy too fast
- Ignored NPC after romantic milestone
- Pursued other NPCs simultaneously (if monogamous personality)
- Broke promises after intimacy
- Revealed secrets NPC shared in confidence

**NPC Behaviors:**
- Hurt, betrayed dialogue
- Refuses to engage romantically again
- May share warnings with other NPCs
- Closes off emotionally

**Claude Might Generate:**
*"I thought you were different. I was wrong. Please leave."*

**Recovery:**
- Sincere apology + time
- Consistent, respectful behavior over many interactions
- Grand gesture that proves change (action, not words)
- May never fully recover - permanent consequences

---

### ðŸ—¡ï¸ **The Enemy**
**Symptoms:** Negative across all dimensions (Low/Negative Trust, Respect, Affection, High Fear)

**Causes:**
- Betrayed NPC directly
- Harmed their loved ones
- Stole from them repeatedly
- Threatened or attacked them
- Destroyed their life's work

**NPC Behaviors:**
- Hostile on sight
- May attack player or call guards
- Spreads negative reputation
- Refuses all interaction
- May plot revenge

**Claude Might Generate:**
*"Get out. If I see you again, I'm calling the guards. Or I'll handle it myself."*

**Recovery:**
- Extremely difficult
- Requires massive reparations
- Time measured in months of consistent positive actions
- May require third-party mediation
- Some actions are unforgivable (kills their family, etc.)

---

### ðŸ˜ **The Stagnant Acquaintance**
**Symptoms:** All stats near zero, high Familiarity but no evolution

**Causes:**
- Only transactional interactions (buy/sell)
- Never have personal conversations
- Don't engage with NPC's stories or problems
- Consistent but boring presence
- No memorable moments

**NPC Behaviors:**
- Polite but generic responses
- Treats player like any other customer
- No special dialogue or opportunities
- No emotional investment

**Claude Might Generate:**
*"Oh, hello again. The usual?"*

**Fix:**
- Ask about NPC's life beyond business
- Engage with personal quests/problems
- Give gifts without expecting transaction
- Visit at unusual times
- Create memorable experiences (help in crisis, share secrets)

---

## Implementation: Dynamic Interaction Recording

### New Universal Method

Replace quest-specific `record_player_action()` with broader `record_interaction()`:

```gdscript
# In base_npc.gd
func record_interaction(interaction_type: String, context: Dictionary) -> void:
    """
    Universal method for recording ANY player interaction.
    
    Args:
        interaction_type: Type of interaction (see categories below)
        context: Dictionary with interaction details
            - description: String (what happened from NPC's perspective)
            - importance: int 1-10
            - emotion: String (NPC's emotional reaction)
            - witnesses: Array[String] (other NPC IDs who saw this)
            - time_of_day: String (morning/afternoon/evening/night)
            - location: String (where it happened)
            - npc_state: String (NPC's emotional state before interaction)
            - player_behavior: String (how player acted)
            - consequences: Array[String] (what changed because of this)
    """
    
    # Build memory from NPC's perspective
    var memory_text = context.description
    
    # Calculate multi-dimensional impact
    var impacts = _calculate_relationship_impacts(interaction_type, context)
    
    # Update relationship stats
    relationship_trust += impacts.trust
    relationship_respect += impacts.respect
    relationship_affection += impacts.affection
    relationship_fear += impacts.fear
    relationship_familiarity += impacts.familiarity
    
    # Clamp values
    relationship_trust = clamp(relationship_trust, -100, 100)
    relationship_respect = clamp(relationship_respect, -100, 100)
    relationship_affection = clamp(relationship_affection, -100, 100)
    relationship_fear = clamp(relationship_fear, -100, 100)
    relationship_familiarity = clamp(relationship_familiarity, 0, 100)
    
    # Store in RAG memory with full context
    rag_memory.store_interaction(
        interaction_type,
        memory_text,
        context.importance,
        context.emotion,
        {
            "interaction_type": interaction_type,
            "time_of_day": context.get("time_of_day", "unknown"),
            "location": context.get("location", current_location),
            "witnesses": context.get("witnesses", []),
            "impacts": impacts,
            "relationship_snapshot": {
                "trust": relationship_trust,
                "respect": relationship_respect,
                "affection": relationship_affection,
                "fear": relationship_fear,
                "familiarity": relationship_familiarity
            }
        }
    )
    
    # Emit signal for world state tracking
    EventBus.emit_signal("npc_relationship_changed", {
        "npc_id": npc_id,
        "player_id": "player",
        "interaction_type": interaction_type,
        "impacts": impacts,
        "new_state": {
            "trust": relationship_trust,
            "respect": relationship_respect,
            "affection": relationship_affection,
            "fear": relationship_fear,
            "familiarity": relationship_familiarity
        }
    })
```

---

### Interaction Type Categories

```gdscript
# Conversation Interactions
"conversation_topic"         # What topic was discussed
"emotional_support"          # Player offered comfort/listening
"emotional_dismissal"        # Player ignored NPC's feelings
"remembered_detail"          # Player recalled something NPC mentioned
"forgot_detail"              # Player forgot important info
"shared_secret"              # Player confided in NPC
"asked_personal_question"    # Player showed interest in NPC's life
"changed_subject"            # Player avoided deep conversation

# Observation Interactions
"witnessed_kindness"         # NPC saw player help someone
"witnessed_cruelty"          # NPC saw player harm someone
"witnessed_combat"           # NPC saw player fight
"witnessed_theft"            # NPC saw player steal
"witnessed_lie"              # NPC caught player lying
"witnessed_bravery"          # NPC saw player face danger
"witnessed_cowardice"        # NPC saw player flee/hide
"value_contradiction"        # Player's actions contradicted their words

# Gift & Favor Interactions
"gift_received"              # Player gave NPC something
"gift_rejected"              # NPC refused player's gift
"unrequested_help"           # Player helped without being asked
"favor_completed"            # Player did what NPC requested
"favor_refused"              # Player declined to help
"favor_failed"               # Player tried but failed to help

# Time & Presence Interactions
"visit_pattern"              # Regular/irregular visits
"absence"                    # Player disappeared for extended time
"showed_up"                  # Player came when needed
"abandoned"                  # Player didn't show in crisis
"shared_danger"              # Faced threat together
"protected"                  # Player defended NPC

# Physical Interactions (Future)
"personal_space_respected"   # Player maintained appropriate distance
"personal_space_violated"    # Player got too close
"touch_welcomed"             # Physical contact (appropriate)
"touch_unwanted"             # Physical contact (inappropriate)
"intimidating_posture"       # Player used threatening body language

# Social Interactions
"introduced_friend"          # Player brought ally to meet NPC
"introduced_enemy"           # Player brought rival/enemy
"defended_reputation"        # Player stood up for NPC to others
"gossiped_about"             # Player spread rumors about NPC
"publicly_praised"           # Player complimented NPC in public
"publicly_criticized"        # Player insulted NPC in public

# Transaction Interactions
"fair_trade"                 # Equitable exchange
"generous_payment"           # Player overpaid
"haggled_hard"               # Player bargained aggressively
"refused_payment"            # Player didn't accept reward
"demanded_discount"          # Player asked for special treatment
"tipped_well"                # Extra payment for service
```

---

## Relationship Impact Calculator

```gdscript
func _calculate_relationship_impacts(interaction_type: String, context: Dictionary) -> Dictionary:
    """
    Returns: { trust: int, respect: int, affection: int, fear: int, familiarity: int }
    """
    
    var impacts = { "trust": 0, "respect": 0, "affection": 0, "fear": 0, "familiarity": 0 }
    
    # Base familiarity - almost everything increases it
    impacts.familiarity = 2
    
    match interaction_type:
        "emotional_support":
            impacts.trust = 8
            impacts.affection = 10
            impacts.familiarity = 5
            
        "emotional_dismissal":
            impacts.trust = -3
            impacts.affection = -5
            
        "remembered_detail":
            var days_since = context.get("time_since_mentioned", 1)
            impacts.affection = min(15, 5 + days_since)  # More impressive if long ago
            impacts.familiarity = 3
            impacts.trust = 2
            
        "witnessed_kindness":
            impacts.respect = 7
            impacts.affection = 5
            impacts.trust = 3
            
        "witnessed_cruelty":
            impacts.respect = -10
            impacts.affection = -8
            impacts.fear = 5
            impacts.trust = -5
            
        "witnessed_combat":
            var style = context.get("style", "normal")
            if style == "non_lethal":
                impacts.respect = 12
                impacts.affection = 5
                impacts.fear = -3
            elif style == "brutal":
                impacts.respect = 5
                impacts.affection = -10
                impacts.fear = 15
                impacts.trust = -3
            else:
                impacts.respect = 8
                impacts.fear = 5
                
        "gift_received":
            var thoughtfulness = context.get("thoughtfulness", "medium")
            if thoughtfulness == "high":
                impacts.affection = 15
                impacts.trust = 8
                impacts.familiarity = 10
            elif thoughtfulness == "medium":
                impacts.affection = 5
                impacts.familiarity = 3
            else:
                impacts.affection = 2  # It's the thought... kind of
                
        "unrequested_help":
            var payment_offered = context.get("payment_offered", "none")
            if payment_offered == "refused":
                impacts.trust = 10
                impacts.affection = 8
                impacts.respect = 5
            else:
                impacts.trust = 5
                impacts.affection = 3
                
        "visit_pattern":
            var frequency = context.get("frequency", "irregular")
            if frequency == "regular":
                impacts.affection = 5
                impacts.familiarity = 3
            elif frequency == "obsessive":
                impacts.affection = -3
                impacts.fear = 2
                
        "absence":
            var duration = context.get("duration_days", 0)
            var had_promise = context.get("context", "none") == "after_promise"
            if had_promise:
                impacts.trust = min(-20, -duration)
                impacts.affection = min(-15, -duration / 2)
            else:
                impacts.affection = min(-5, -duration / 10)
                
        "shared_danger":
            impacts.trust = 20
            impacts.respect = 15
            impacts.affection = 10
            impacts.familiarity = 15
            impacts.fear = -10  # Less afraid after seeing player is ally
            
        "value_contradiction":
            impacts.trust = -15
            impacts.respect = -5
            impacts.familiarity = 5  # Know player better, but negatively
            
        "protected":
            impacts.trust = 12
            impacts.affection = 10
            impacts.respect = 8
            impacts.fear = -5
            
        # Add more cases as needed...
    
    # Personality modifiers
    impacts = _apply_personality_modifiers(impacts, interaction_type, context)
    
    # Existing relationship modifiers
    impacts = _apply_relationship_context(impacts, interaction_type)
    
    return impacts
```

---

## Context-Aware Impact Modification

```gdscript
func _apply_relationship_context(impacts: Dictionary, interaction_type: String) -> Dictionary:
    """
    Same action has different impact based on current relationship state.
    """
    
    var modified = impacts.duplicate()
    
    # High trust magnifies positive affection gains
    if relationship_trust > 50 and modified.affection > 0:
        modified.affection *= 1.5
        
    # High fear reduces trust gains
    if relationship_fear > 50 and modified.trust > 0:
        modified.trust *= 0.5
        
    # Low familiarity means more cautious trust changes
    if relationship_familiarity < 30:
        modified.trust *= 0.7
        
    # High affection makes betrayals hurt more
    if relationship_affection > 60 and modified.trust < -5:
        modified.affection += modified.trust * 2  # Double the affection loss
        
    return modified

func _apply_personality_modifiers(impacts: Dictionary, interaction_type: String, context: Dictionary) -> Dictionary:
    """
    NPC personality traits modify how they react to interactions.
    Load from personality resource.
    """
    
    var modified = impacts.duplicate()
    var personality = personality_resource  # Loaded from .tres file
    
    # Example: Gregor values competence, so respect gains are amplified
    if personality.has("values_competence") and personality.values_competence:
        if modified.respect > 0:
            modified.respect *= 1.3
            
    # Example: Gregor is lonely, so time spent together matters more
    if personality.has("lonely") and personality.lonely:
        if interaction_type in ["visit_pattern", "emotional_support", "shared_secret"]:
            modified.affection *= 1.5
            
    # Example: Gregor fears powerful people, so combat displays increase fear more
    if personality.has("fearful_of_power") and personality.fearful_of_power:
        if modified.fear > 0:
            modified.fear *= 1.2
            
    return modified
```

---

## Enhanced Claude Prompt with Multi-Dimensional Context

```gdscript
# In context_builder.gd
func _build_system_prompt(npc: BaseNPC, raw_memories: Array) -> String:
    var prompt = npc.personality_resource.base_personality
    
    prompt += "\n\n## Your Relationship with the Player\n"
    
    # Multi-dimensional relationship display
    prompt += "**Trust:** %d/100 - %s\n" % [npc.relationship_trust, _interpret_trust(npc.relationship_trust)]
    prompt += "**Respect:** %d/100 - %s\n" % [npc.relationship_respect, _interpret_respect(npc.relationship_respect)]
    prompt += "**Affection:** %d/100 - %s\n" % [npc.relationship_affection, _interpret_affection(npc.relationship_affection)]
    prompt += "**Fear:** %d/100 - %s\n" % [npc.relationship_fear, _interpret_fear(npc.relationship_fear)]
    prompt += "**Familiarity:** %d/100 - %s\n\n" % [npc.relationship_familiarity, _interpret_familiarity(npc.relationship_familiarity)]
    
    # Categorized memories
    var categorized = _categorize_memories_enhanced(raw_memories)
    
    prompt += "## How Your Relationship Has Evolved\n\n"
    
    if categorized.significant_moments.size() > 0:
        prompt += "**Significant Moments:**\n"
        for memory in categorized.significant_moments:
            prompt += "- %s (Impact: Trust %+d, Respect %+d, Affection %+d)\n" % [
                memory.description,
                memory.metadata.impacts.trust,
                memory.metadata.impacts.respect,
                memory.metadata.impacts.affection
            ]
        prompt += "\n"
    
    if categorized.conversations.size() > 0:
        prompt += "**Meaningful Conversations:**\n"
        for memory in categorized.conversations.slice(0, 5):  # Top 5
            prompt += "- %s\n" % memory.description
        prompt += "\n"
    
    if categorized.observations.size() > 0:
        prompt += "**What You've Observed:**\n"
        for memory in categorized.observations.slice(0, 3):
            prompt += "- %s\n" % memory.description
        prompt += "\n"
    
    # Behavioral guidance based on current state
    prompt += "## How to Behave Based on Your Feelings\n\n"
    prompt += _generate_behavioral_guidance(npc)
    
    return prompt

func _generate_behavioral_guidance(npc: BaseNPC) -> String:
    """
    Dynamic behavioral instructions based on relationship state.
    """
    var guidance = ""
    
    # Trust-based behavior
    if npc.relationship_trust > 70:
        guidance += "- You trust them deeply. Share secrets, ask for help with serious matters.\n"
    elif npc.relationship_trust > 30:
        guidance += "- You're starting to trust them. Be open but not fully vulnerable yet.\n"
    elif npc.relationship_trust < -30:
        guidance += "- You don't trust them. Be guarded, don't believe their promises.\n"
    
    # Respect-based behavior
    if npc.relationship_respect > 70:
        guidance += "- You respect their abilities and judgment. Seek their opinion, defer to expertise.\n"
    elif npc.relationship_respect < -30:
        guidance += "- You don't respect them. Dismissive tone, don't take them seriously.\n"
    
    # Affection-based behavior
    if npc.relationship_affection > 70:
        guidance += "- You care deeply about them. Show warmth, concern for their wellbeing.\n"
        if npc.relationship_trust > 60 and npc.personality_resource.romance_available:
            guidance += "- You're attracted to them. Flirt openly, hint at deeper feelings.\n"
    elif npc.relationship_affection > 30:
        guidance += "- You like them. Be friendly, enjoy their company.\n"
    elif npc.relationship_affection < -30:
        guidance += "- You dislike them. Cold, minimal interaction.\n"
    
    # Fear-based behavior
    if npc.relationship_fear > 70:
        guidance += "- You're terrified of them. Submissive, eager to please, avoid conflict.\n"
    elif npc.relationship_fear > 30:
        guidance += "- You're wary of them. Careful with words, don't provoke.\n"
    
    # Conflicted states
    if npc.relationship_affection > 50 and npc.relationship_fear > 50:
        guidance += "- You have conflicted feelings: attracted but afraid. Show this internal conflict.\n"
    
    if npc.relationship_trust < 20 and npc.relationship_respect > 60:
        guidance += "- You respect but don't trust them. Acknowledge skill while maintaining distance.\n"
    
    return guidance
```

---

## Testing Optimal Evolution

### Test Scenario 1: Building Trust Through Consistency

```gdscript
# Day 1: Promise to help
gregor.record_interaction("favor_accepted", {
    "description": "Player promised to help find stolen supplies",
    "importance": 7,
    "emotion": "hopeful"
})
# Result: Trust +5, Affection +3

# Day 3: Player shows up as promised
gregor.record_interaction("showed_up", {
    "description": "Player came back as promised to help",
    "importance": 8,
    "emotion": "pleased"
})
# Result: Trust +10, Affection +5, Familiarity +5

# Day 5: Success
gregor.record_interaction("favor_completed", {
    "description": "Player recovered stolen supplies",
    "importance": 9,
    "emotion": "grateful"
})
# Result: Trust +12, Respect +10, Affection +8

# Expected State: Trust 27, Respect 10, Affection 16
# NPC Behavior: Warmer, more welcoming, starts to rely on player
```

### Test Scenario 2: Thoughtful Gift Evolution

```gdscript
# Week 1: Generic interaction
gregor.record_interaction("conversation_topic", {
    "description": "Talked about general shop business",
    "importance": 4,
    "emotion": "neutral"
})

# Week 2: Player asks personal question
gregor.record_interaction("asked_personal_question", {
    "description": "Player asked about my daughter Elena and her love of horses",
    "importance": 7,
    "emotion": "touched"
})
# Result: Affection +8, Familiarity +5, Trust +2

# Week 3: Player brings horse-riding book
gregor.record_interaction("gift_received", {
    "description": "Player brought rare book about horse-riding for Elena. They remembered!",
    "importance": 9,
    "emotion": "deeply_touched",
    "thoughtfulness": "high"
})
# Result: Affection +15 (Ã—1.5 from existing trust), Trust +8, Familiarity +10

# Expected State: Trust 10, Affection 23, Familiarity 15
# NPC Behavior: Much warmer, considers player a friend, shares more personal stories
```

---

## Measuring Evolution Success

### Metrics to Track

```gdscript
# In world_state.gd or analytics system
var evolution_metrics = {
    "trajectory": "optimal",  # optimal, sub-optimal, failing
    "consistency_score": 0.0,  # How consistent player's behavior is
    "depth_score": 0.0,        # How deep relationship is (balance across dimensions)
    "authenticity_score": 0.0, # How well actions align with words
    "memorable_moments": 0     # Count of high-importance interactions
}

func calculate_evolution_quality(npc_id: String) -> Dictionary:
    var npc = get_npc(npc_id)
    var memories = get_all_memories(npc_id)
    
    # Consistency: Do actions contradict each other?
    var contradictions = count_contradictory_actions(memories)
    var consistency = 1.0 - (contradictions / max(1.0, memories.size()))
    
    # Depth: Are multiple dimensions developing?
    var dimensions_developing = 0
    if abs(npc.relationship_trust) > 30: dimensions_developing += 1
    if abs(npc.relationship_respect) > 30: dimensions_developing += 1
    if abs(npc.relationship_affection) > 30: dimensions_developing += 1
    if npc.relationship_familiarity > 40: dimensions_developing += 1
    var depth = dimensions_developing / 4.0
    
    # Authenticity: Actions vs words
    var value_contradictions = count_value_contradictions(memories)
    var authenticity = 1.0 - (value_contradictions / max(1.0, memories.size()))
    
    # Memorable moments
    var memorable = memories.filter(func(m): return m.importance >= 8).size()
    
    var trajectory = "optimal"
    if consistency < 0.6 or authenticity < 0.5:
        trajectory = "sub-optimal"
    if consistency < 0.3 or depth < 0.25:
        trajectory = "failing"
    
    return {
        "trajectory": trajectory,
        "consistency_score": consistency,
        "depth_score": depth,
        "authenticity_score": authenticity,
        "memorable_moments": memorable
    }
```

---

## What's In Scope vs Out of Scope

### âœ… In Scope: What Influences Behavior Evolution

**Everything the player does around NPCs:**
- Dialogue choices and topics discussed
- Actions witnessed (combat, theft, kindness, cruelty)
- Promises made and kept/broken
- Gifts given (value and thoughtfulness)
- Time spent together vs absence
- How player treats others (NPCs notice)
- Player's reputation and faction alignments
- Consistency between words and actions
- Emotional availability and support
- Physical presence during crises
- Respect for boundaries
- Treatment of NPC's loved ones
- Success/failure in challenges
- Body language and proximity (future)
- Who player brings around NPC
- Time of day and frequency of visits
- Player's moral choices in difficult situations

**World context:**
- Events happening around the NPC
- NPC's current emotional state
- Existing relationship with player (history matters)
- NPC's personality traits and values
- Cultural/faction context
- Other NPCs' opinions of player
- Rumors and reputation

### âŒ Out of Scope: What Doesn't Influence Evolution

**Player character attributes that NPCs can't perceive:**
- Stats/skills the player never demonstrates
- Internal character thoughts (unless player shares them)
- Player's gender/appearance (NPCs respond to actions, not demographics)
- Metagame knowledge (save/load states, player's real-world identity)
- Achievements or trophies
- Game difficulty setting
- Controller vs keyboard preference
- Real-world time spent playing

**System mechanics:**
- Bugs or glitches
- Fast travel vs walking (unless NPC witnesses it)
- Inventory management (unless player shows items)
- Reading books/notes in private
- Crafting alone in hideout

**Player choices NPC isn't aware of:**
- Actions in distant locations (unless word spreads)
- Private conversations with other NPCs (unless gossip reaches them)
- Secret faction memberships (until revealed)
- Player's internal motivations (until expressed)

### ðŸŽ¯ Core Principle: Observable Actions Drive Evolution

**If an NPC can see it, hear about it, or experience it â†’ It influences behavior**  
**If it happens off-screen and leaves no trace â†’ It doesn't**

NPCs react to the world as they perceive it, not omnisciently. This creates:
- Realistic misunderstandings (NPC doesn't know why you did something)
- Reputation management gameplay (control what NPCs learn about you)
- Dramatic irony (player knows truth, NPC doesn't)
- Opportunities for reveals and explanations

---

## Next Implementation Steps

1. **Add relationship stat variables to BaseNPC**
   - `relationship_trust`, `relationship_respect`, `relationship_affection`, `relationship_fear`, `relationship_familiarity`

2. **Implement `record_interaction()` method**
   - Replace `record_player_action()`
   - Add `_calculate_relationship_impacts()`
   - Add personality modifier system

3. **Update ContextBuilder**
   - Multi-dimensional relationship display
   - Enhanced memory categorization
   - Dynamic behavioral guidance generation

4. **Create interaction triggers in game**
   - Conversation topic tracking
   - Witness system for observations
   - Time/presence tracking

5. **Test optimal vs sub-optimal paths**
   - Consistent trust-building
   - Thoughtful gift progression
   - Contradictory behavior patterns

6. **Add personality resource fields**
   - Sexual/romantic orientation
   - Intimacy preferences (romantic/casual/none)
   - Relationship style (monogamous/polyamorous)
   - Values, fears, preferences
   - Modifier weights for interactions

7. **Implement intimacy scene system**
   - Trigger conditions based on relationship + personality
   - Pre-intimacy dialogue and consent
   - Fade-to-black scene transitions
   - Post-intimacy memory storage and relationship updates
   - Diverging paths for romantic vs casual encounters

---

**The goal: NPCs that feel alive because they evolve dynamically through ALL observable interactions, not just scripted quest milestones. Every player action that an NPC can perceive shapes who that NPC becomes in relation to the player.**
